<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>place.plugins.alazartech.alazartech &#8212; PLACE 0.10.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/pydoctheme.css" />
    
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    
    <script src="../../../../_static/sidebar.js"></script>
    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="shortcut icon" type="image/png" href="../../../../_static/favicon.png" />
    <meta name="viewport" content="width=device-width,initial-scale=0.8">
    
    

  </head><body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="responsive-menu"><a href="#sidebar-anchor" title="Navigation">&#9776;</a></li>
        <li><a href="../../../../index.html">PLACE 0.10.0 documentation</a> &#187;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
    
        <div class="badge">
            <a href="https://github.com/PALab/place/">Fork me on GitHub</a>
            <img src="../../../../_static/right-red@2x.png">
        </div>
    
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for place.plugins.alazartech.alazartech</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;PLACE plugin for the AlazarTech ATS660 and ATS9440 oscilloscope cards.</span>

<span class="sd">Oscilloscopes are at the heart of many data acquisition experiments and contain</span>
<span class="sd">many configuration options. At the time of this writing, this PLACE module is by</span>
<span class="sd">far the most complex. However, even though it is complex, it still follows the</span>
<span class="sd">basic PLACE philosophy of config/update/cleanup.</span>

<span class="sd">This plugin can be used as an example for how to program complex instruments</span>
<span class="sd">into the PLACE system.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">c_void_p</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_agg</span> <span class="kn">import</span> <span class="n">FigureCanvasAgg</span> <span class="k">as</span> <span class="n">FigureCanvas</span>
<span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="kn">import</span> <span class="n">Figure</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">place.plugins.instrument</span> <span class="kn">import</span> <span class="n">Instrument</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">atsapi</span> <span class="k">as</span> <span class="n">ats</span>
<span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">dummy_atsapi</span> <span class="k">as</span> <span class="n">ats</span>
<span class="nb">setattr</span><span class="p">(</span><span class="n">ats</span><span class="p">,</span> <span class="s1">&#39;TRIG_FORCE&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>


<div class="viewcode-block" id="ATSGeneric"><a class="viewcode-back" href="../../../../alazartech.html#place.plugins.alazartech.alazartech.ATSGeneric">[docs]</a><span class="k">class</span> <span class="nc">ATSGeneric</span><span class="p">(</span><span class="n">Instrument</span><span class="p">,</span> <span class="n">ats</span><span class="o">.</span><span class="n">Board</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generic AlazarTech oscillscope card.</span>

<span class="sd">    All AlazarTech cards use the same underlying driver. This class provides</span>
<span class="sd">    access to these universal features. This class should be overridden if</span>
<span class="sd">    classes are needed for specific cards.</span>

<span class="sd">    .. note::</span>

<span class="sd">        This class currently only supports boards providing data in an</span>
<span class="sd">        unsigned, 2 bytes per sample, format. It should support 12, 14, and</span>
<span class="sd">        16-bits per sample.  If 8-bits per sample is desired, functionality</span>
<span class="sd">        will need to be added to this class.</span>

<span class="sd">    AlazarTech requires the following configuration data (accessible as</span>
<span class="sd">    self._config[&#39;*key*&#39;]):</span>

<span class="sd">    ========================= ============== ================================================</span>
<span class="sd">    Key                       Type           Meaning</span>
<span class="sd">    ========================= ============== ================================================</span>
<span class="sd">    clock_source              string         the timing clock to use</span>
<span class="sd">                                             (must name a constant from the ATS driver file)</span>
<span class="sd">    clock_edge                string         the edge of the clock signal to use</span>
<span class="sd">                                             (must name a constant from the ATS driver file)</span>
<span class="sd">    trigger_operation         string         how the trigger engine signals are joined</span>
<span class="sd">                                             (must name a constant from the ATS driver file)</span>
<span class="sd">    trigger_engine_1          string         the first trigger engine to use</span>
<span class="sd">                                             (must name a constant from the ATS driver file)</span>
<span class="sd">    trigger_source_1          string         the source of the first trigger</span>
<span class="sd">                                             (must name a constant from the ATS driver file)</span>
<span class="sd">    trigger_slope_1           string         the signal slope that the first trigger</span>
<span class="sd">                                             responds to</span>
<span class="sd">    trigger_level_1           int            the signal level of the first trigger, where</span>
<span class="sd">                                             ``128`` is near 0 volts, ``0`` is the minimun</span>
<span class="sd">                                             input range, and ``255`` is the maximum input</span>
<span class="sd">                                             range</span>
<span class="sd">                                             (must name a constant from the ATS driver file)</span>
<span class="sd">    trigger_engine_2          string         the second trigger engine to use</span>
<span class="sd">                                             (must name a constant from the ATS driver file)</span>
<span class="sd">    trigger_source_2          string         the source of the second trigger</span>
<span class="sd">                                             (must name a constant from the ATS driver file)</span>
<span class="sd">    trigger_slope_2           string         the signal slope that the second trigger</span>
<span class="sd">                                             responds to</span>
<span class="sd">                                             (must name a constant from the ATS driver file)</span>
<span class="sd">    trigger_level_2           int            the signal level of the second trigger, where</span>
<span class="sd">                                             ``128`` is near 0 volts, ``0`` is the minimun</span>
<span class="sd">                                             input range, and ``255`` is the maximum input</span>
<span class="sd">                                             range</span>
<span class="sd">    pre_trigger_samples       int            number of samples to return prior to the trigger</span>
<span class="sd">    post_trigger_samples      int            number of samples to return after the trigger</span>
<span class="sd">    records                   int            the number of records to acquire (per update)</span>
<span class="sd">    average                   bool           ``True`` if records should be averaged into one</span>
<span class="sd">    sample_rate               string         the sample rate to be used on the card</span>
<span class="sd">                                             (must name a constant from the ATS driver file)</span>
<span class="sd">    decimation                int            a decimation factor for the signal</span>
<span class="sd">    plot                      string         ``&#39;yes&#39;`` if plotting should occur</span>
<span class="sd">    analog_inputs             list           configuration data for the input channels</span>
<span class="sd">                                             (see the ``AnalogInput`` class for more info)</span>
<span class="sd">    ========================= ============== ================================================</span>

<span class="sd">    AlazarTech will produce the following experimental metadata:</span>

<span class="sd">    ========================= ============== ================================================</span>
<span class="sd">    Key                       Type           Meaning</span>
<span class="sd">    ========================= ============== ================================================</span>
<span class="sd">    bits_per_sample           int            the bits resolution of samples taken</span>
<span class="sd">    samples_per_record        int            the number of samples in each record saved by</span>
<span class="sd">                                             PLACE</span>
<span class="sd">    sampling_rate             int            the integer calculation of the sampling rate</span>
<span class="sd">                                             (in samples/second)</span>
<span class="sd">    ========================= ============== ================================================</span>

<span class="sd">    AlazarTech will produce the following experimental data:</span>

<span class="sd">    +---------------+-------------------------+-------------------------+</span>
<span class="sd">    | Heading       | Type                    | Meaning                 |</span>
<span class="sd">    +===============+=========================+=========================+</span>
<span class="sd">    | trace         | (channel,record,sample) | the trace data recorded |</span>
<span class="sd">    |               | array of uint16         | on the oscilloscope     |</span>
<span class="sd">    +---------------+-------------------------+-------------------------+</span>

<span class="sd">    .. note::</span>

<span class="sd">        We will add the instrument class name to the heading. For example,</span>
<span class="sd">        ``trace`` will be recorded as ``ATS9440-trace`` when using the</span>
<span class="sd">        ATS9440 oscilloscope card. The reason for this is because NumPy will</span>
<span class="sd">        not check for duplicate heading names, so prepending the class name</span>
<span class="sd">        greatly reduces the likelihood of data loss.</span>

<span class="sd">    Example code for reading AlazarTech data from a PLACE .npy file::</span>

<span class="sd">        import numpy as np</span>
<span class="sd">        data = np.load(&#39;scan_data.npy&#39;)</span>
<span class="sd">        heading = &#39;ATS660-trace&#39;</span>
<span class="sd">        row = 0  # corresponds to the &#39;update&#39; number</span>
<span class="sd">        alazartech_data = data[heading][row]</span>
<span class="sd">        channel = 0</span>
<span class="sd">        record = 0</span>
<span class="sd">        sample = 9</span>
<span class="sd">        sample10 = alazartech_data[channel][record][sample]</span>

<span class="sd">    In this example, we are looking at the data in a file named</span>
<span class="sd">    ``data_000.npy``. This file is created after the first update in a</span>
<span class="sd">    PLACE experiment and contains one row of data. The AlazarTech data is</span>
<span class="sd">    therefore located in the column named ``&#39;ATS660-trace&#39;`` and row ``0``.</span>
<span class="sd">    From there, we can examine the data as desired.</span>

<span class="sd">    If the experiment has completed normally, all the rows will be stored in a</span>
<span class="sd">    single file, named ``data.npy``. In this case, the code above is the same,</span>
<span class="sd">    but you would need to specify the row value desired.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_bytes_per_sample</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="c1"># (&lt;)little-endian, (u)unsigned</span>
    <span class="n">_data_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;&lt;u&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">_bytes_per_sample</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">plotter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor</span>

<span class="sd">        :param config: configuration data (from JSON)</span>
<span class="sd">        :type config: dict</span>

<span class="sd">        :param plotter: a plotting object to return plots to the web interface</span>
<span class="sd">        :type plotter: plots.PlacePlotter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Instrument</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">plotter</span><span class="p">)</span>
        <span class="n">ats</span><span class="o">.</span><span class="n">Board</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updates</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analog_inputs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_samples</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sample_rate</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wiggle_figs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wiggle_axes</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="ATSGeneric.config"><a class="viewcode-back" href="../../../../alazartech.html#place.plugins.alazartech.alazartech.ATSGeneric.config">[docs]</a>    <span class="k">def</span> <span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">total_updates</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure the AlazarTech oscilliscope card.</span>

<span class="sd">        This method is responsible for reading configuration date from</span>
<span class="sd">        ``self._config`` and using this data to configure the oscilloscope card</span>
<span class="sd">        for data acquisition. We mirror the steps suggested by the SDK Guide:</span>

<span class="sd">        .. epigraph::</span>

<span class="sd">            &quot;*Before acquiring data from a board system, an application must</span>
<span class="sd">            configure the timebase, analog inputs, and trigger system settings</span>
<span class="sd">            for each board in the board system.*&quot;</span>

<span class="sd">            -- ATS SDK Guide</span>

<span class="sd">        After configuring the board, this method also performs the first data</span>
<span class="sd">        acquisition steps by setting the record size and the record count.</span>

<span class="sd">        :param metadata: PLACE maintains metadata for each experiment in a</span>
<span class="sd">                         dictionary object. During the configuration phase,</span>
<span class="sd">                         this dictionary is passed to each instrument through</span>
<span class="sd">                         this function so that relevant instrument data can be</span>
<span class="sd">                         recorded into it. Instruments should record</span>
<span class="sd">                         information that is relevant to the entire experiment,</span>
<span class="sd">                         but is also specific to the instrument. For example,</span>
<span class="sd">                         if an instrument is using one of many filters during</span>
<span class="sd">                         this experiment, it would be appropriate to record the</span>
<span class="sd">                         filter into the experiment metadata.</span>
<span class="sd">        :type metadata: dict</span>

<span class="sd">        :param total_updates: This value will always be used to inform each</span>
<span class="sd">                              instrument of the number of updates (or steps)</span>
<span class="sd">                              that will be perfomed during this experiment.</span>
<span class="sd">                              Instruments should use this value to determine</span>
<span class="sd">                              when to perform specific tasks during the</span>
<span class="sd">                              experiment.  For example, some instruments may</span>
<span class="sd">                              want to perform a task at the midpoint of an</span>
<span class="sd">                              experiment and can therefore use this value to</span>
<span class="sd">                              determine which update will represent the</span>
<span class="sd">                              midpoint.</span>
<span class="sd">        :type total_updates: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updates</span> <span class="o">=</span> <span class="n">total_updates</span>
        <span class="c1"># execute configuration commands on the card</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_timebase</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_analog_inputs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_trigger_system</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_record</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">c_bits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getChannelInfo</span><span class="p">()</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;bits_per_sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_bits</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_samples</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;pre_trigger_samples&#39;</span><span class="p">]</span>
                         <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;post_trigger_samples&#39;</span><span class="p">])</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;samples_per_record&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_samples</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;plot&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wiggle_figs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">7.29</span><span class="p">,</span> <span class="mf">4.17</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">96</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;analog_inputs&#39;</span><span class="p">]))]</span>
            <span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">FigureCanvas</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span> <span class="k">for</span> <span class="n">fig</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wiggle_figs</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wiggle_axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span>
                <span class="mi">111</span><span class="p">)</span> <span class="k">for</span> <span class="n">fig</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wiggle_figs</span><span class="p">]</span></div>

<div class="viewcode-block" id="ATSGeneric.update"><a class="viewcode-back" href="../../../../alazartech.html#place.plugins.alazartech.alazartech.ATSGeneric.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update_number</span><span class="p">,</span> <span class="n">progress</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Record a trace using the current configuration.</span>

<span class="sd">        :param update_number: This will be the current update number (starting</span>
<span class="sd">                              with 0) of the experiment. Instruments could</span>
<span class="sd">                              certainly count the number of updates themselves,</span>
<span class="sd">                              but this is provided as a convenience.</span>
<span class="sd">        :type update_number: int</span>

<span class="sd">        :param progress: A blank dictionary for sending data back to the frontend</span>
<span class="sd">        :type progress: dict</span>

<span class="sd">        :returns: a multi-dimensional array containing the channel, record, and</span>
<span class="sd">                  sample data.</span>
<span class="sd">        :rtype: numpy.array dtype=&#39;(*number_channels*, *number_records*,</span>
<span class="sd">                *number_samples*)uint16&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># build data array</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;analog_inputs&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;average&#39;</span><span class="p">]:</span>
            <span class="n">records</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;records&#39;</span><span class="p">]</span>
        <span class="n">type_str</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">)</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span>
                                         <span class="n">records</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">_samples</span><span class="p">,</span>
                                         <span class="n">ATSGeneric</span><span class="o">.</span><span class="n">_data_type</span><span class="p">)</span>
        <span class="n">field</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-trace&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="n">field</span><span class="p">,</span> <span class="n">type_str</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startCapture</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_trigger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_from_card</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;plot&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_draw_plot</span><span class="p">(</span><span class="n">update_number</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

<div class="viewcode-block" id="ATSGeneric.cleanup"><a class="viewcode-back" href="../../../../alazartech.html#place.plugins.alazartech.alazartech.ATSGeneric.cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abort</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Nothing to cleanup</span>

<span class="sd">        :param abort: indicates the experiment has been stopped rather than</span>
<span class="sd">                      having finished normally</span>
<span class="sd">        :type abort: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">_config_timebase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the capture clock&quot;&quot;&quot;</span>
        <span class="n">sample_rate</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;sample_rate&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sample_rate</span> <span class="o">=</span> <span class="n">_sample_rate_to_hertz</span><span class="p">(</span><span class="n">sample_rate</span><span class="p">)</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;sampling_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setCaptureClock</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">ats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;clock_source&#39;</span><span class="p">]),</span>
                             <span class="n">sample_rate</span><span class="p">,</span>
                             <span class="nb">getattr</span><span class="p">(</span><span class="n">ats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;clock_edge&#39;</span><span class="p">]),</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;decimation&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_config_analog_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Specify the desired input range, termination, and coupling of an</span>
<span class="sd">        input channel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analog_inputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">input_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;analog_inputs&#39;</span><span class="p">]:</span>
            <span class="n">analog_input</span> <span class="o">=</span> <span class="n">AnalogInput</span><span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">ats</span><span class="p">,</span> <span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;input_channel&#39;</span><span class="p">]),</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">ats</span><span class="p">,</span> <span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;input_coupling&#39;</span><span class="p">]),</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">ats</span><span class="p">,</span> <span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;input_range&#39;</span><span class="p">]),</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">ats</span><span class="p">,</span> <span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;input_impedance&#39;</span><span class="p">]))</span>
            <span class="c1">#pylint: disable=protected-access</span>
            <span class="n">analog_input</span><span class="o">.</span><span class="n">_initialize_on_board</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_analog_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">analog_input</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_config_trigger_system</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure each of the two trigger engines&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;trigger_source_1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;TRIG_FORCE&quot;</span><span class="p">:</span>
            <span class="n">source_1</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ats</span><span class="p">,</span> <span class="s2">&quot;TRIG_CHAN_A&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">source_1</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;trigger_source_1&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;trigger_source_2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;TRIG_FORCE&quot;</span><span class="p">:</span>
            <span class="n">source_2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ats</span><span class="p">,</span> <span class="s2">&quot;TRIG_CHAN_A&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">source_2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;trigger_source_2&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setTriggerOperation</span><span class="p">(</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">ats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;trigger_operation&#39;</span><span class="p">]),</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">ats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;trigger_engine_1&#39;</span><span class="p">]),</span>
            <span class="n">source_1</span><span class="p">,</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">ats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;trigger_slope_1&#39;</span><span class="p">]),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;trigger_level_1&#39;</span><span class="p">],</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">ats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;trigger_engine_2&#39;</span><span class="p">]),</span>
            <span class="n">source_2</span><span class="p">,</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">ats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;trigger_slope_2&#39;</span><span class="p">]),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;trigger_level_2&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_config_record</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the record size and count on the card&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setRecordSize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;pre_trigger_samples&#39;</span><span class="p">],</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;post_trigger_samples&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setRecordCount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;records&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_wait_for_trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait for a trigger event until the timeout.</span>

<span class="sd">        This method will wait for a trigger event, but will eventually timeout.</span>
<span class="sd">        When this happens, it will either raise an error or force a trigger</span>
<span class="sd">        event, depending on the input.</span>

<span class="sd">        :param timeout: number of seconds to wait for a trigger event</span>
<span class="sd">        :type timeout: int</span>

<span class="sd">        :raises RuntimeError: if timeout occurs and force is set to False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#timeout = max(100, self._config[&#39;records&#39;])</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ceil</span><span class="p">(</span><span class="n">timeout</span> <span class="o">/</span> <span class="mf">0.1</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">busy</span><span class="p">():</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;trigger_source_1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;TRIG_FORCE&#39;</span>
                    <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;trigger_source_2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;TRIG_FORCE&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">forceTrigger</span><span class="p">()</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Alazartech: Timeout ocurred. Continuing&quot;</span><span class="p">)</span>
            <span class="c1">#raise RuntimeError(</span>
            <span class="c1">#    &quot;timeout occurred before card recorded all records&quot;)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;triggered&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_from_card</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reads the records from the card memory into the data buffer.&quot;&quot;&quot;</span>
        <span class="n">pre_trig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;pre_trigger_samples&#39;</span><span class="p">]</span>
        <span class="n">post_trig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;post_trigger_samples&#39;</span><span class="p">]</span>
        <span class="n">transfer_length</span> <span class="o">=</span> <span class="n">pre_trig</span> <span class="o">+</span> <span class="n">post_trig</span> <span class="o">+</span> <span class="mi">16</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;records&#39;</span><span class="p">]</span>
        <span class="n">transfer_offset</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">pre_trig</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">records</span><span class="p">,</span> <span class="n">transfer_length</span><span class="p">),</span> <span class="n">ATSGeneric</span><span class="o">.</span><span class="n">_data_type</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">channel_number</span><span class="p">,</span> <span class="n">analog_input</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_analog_inputs</span><span class="p">):</span>
            <span class="c1">#pylint: disable=protected-access</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="n">analog_input</span><span class="o">.</span><span class="n">_get_input_channel</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">records</span><span class="p">):</span>
                <span class="n">record_num</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># 1-indexed</span>
                <span class="c1"># read data from card</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span>
                          <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">c_void_p</span><span class="p">),</span>
                          <span class="n">ATSGeneric</span><span class="o">.</span><span class="n">_bytes_per_sample</span><span class="p">,</span>
                          <span class="n">record_num</span><span class="p">,</span>
                          <span class="n">transfer_offset</span><span class="p">,</span>
                          <span class="n">transfer_length</span><span class="p">)</span>
                <span class="c1"># save each record if not being averaged</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;average&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">value_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_values</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="o">-</span><span class="mi">16</span><span class="p">])</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-trace&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">channel_number</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_data</span>
            <span class="c1"># save the average record only if average is requested</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;average&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">averaged_record</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">16</span><span class="p">]</span>
                <span class="n">value_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_values</span><span class="p">(</span><span class="n">averaged_record</span><span class="p">)</span>
                <span class="n">field</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-trace&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">channel_number</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_data</span>

    <span class="k">def</span> <span class="nf">_convert_to_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert ATS data into 16-bit integer values for saving.</span>

<span class="sd">        :param data: the values read from the ATS card</span>
<span class="sd">        :type data: numpy.ndarray</span>

<span class="sd">        :returns: 16-bit integers</span>
<span class="sd">        :rtype: numpy.ndarray</span>

<span class="sd">        :raises NotImplementedError: if bits per sample is out of range</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">c_bits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getChannelInfo</span><span class="p">()</span>
        <span class="n">bits</span> <span class="o">=</span> <span class="n">c_bits</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">8</span> <span class="o">&lt;</span> <span class="n">bits</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;bits per sample must be between 9 and 16&quot;</span><span class="p">)</span>
        <span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">-</span> <span class="n">bits</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span> <span class="o">/</span> <span class="mi">2</span><span class="o">**</span><span class="n">bit_shift</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">ATSGeneric</span><span class="o">.</span><span class="n">_data_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_draw_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update_number</span><span class="p">):</span>
        <span class="n">pre_trig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;pre_trigger_samples&#39;</span><span class="p">]</span>
        <span class="n">post_trig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;post_trigger_samples&#39;</span><span class="p">]</span>
        <span class="n">first_record</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">usec_delta</span> <span class="o">=</span> <span class="mf">1000000.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_rate</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">pre_trig</span><span class="p">),</span> <span class="n">post_trig</span><span class="p">)</span> <span class="o">*</span> <span class="n">usec_delta</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">c_bits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getChannelInfo</span><span class="p">()</span>
        <span class="n">bits</span> <span class="o">=</span> <span class="n">c_bits</span><span class="o">.</span><span class="n">value</span>

        <span class="n">place_headings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-trace&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">place_headings</span><span class="p">):</span>
            <span class="n">ydata</span> <span class="o">=</span> <span class="n">channel</span><span class="p">[</span><span class="n">first_record</span><span class="p">]</span>
            <span class="n">letter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;analog_inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;input_channel&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Channel </span><span class="si">{}</span><span class="s1"> trace&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">letter</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotter</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
                <span class="n">title</span><span class="p">,</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plotter</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
                        <span class="n">ydata</span><span class="p">,</span>
                        <span class="n">xdata</span><span class="o">=</span><span class="n">times</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span>
                        <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">letter</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># TODO: add axis labels/limits when PLACE supports it</span>
            <span class="c1"># plt.xlabel(r&#39;$\mu$secs&#39;)</span>
            <span class="c1"># plt.ylim((0, 2**bits))</span>
            <span class="c1"># plt.tight_layout()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">place_headings</span><span class="p">):</span>
            <span class="n">letter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;analog_inputs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;input_channel&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Channel </span><span class="si">{}</span><span class="s1"> wiggle plot&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">letter</span><span class="p">)</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">channel</span><span class="p">[</span><span class="n">first_record</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">bits</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">update_number</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wiggle_axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">trace</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wiggle_axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span>
                <span class="n">times</span><span class="p">,</span>
                <span class="n">trace</span><span class="p">,</span>
                <span class="n">update_number</span><span class="p">,</span>
                <span class="n">where</span><span class="o">=</span><span class="n">trace</span> <span class="o">&gt;</span> <span class="n">update_number</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wiggle_axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updates</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wiggle_axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Update Number&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wiggle_axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\mu$secs&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotter</span><span class="o">.</span><span class="n">png</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wiggle_figs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span></div>


<div class="viewcode-block" id="AnalogInput"><a class="viewcode-back" href="../../../../alazartech.html#place.plugins.alazartech.alazartech.AnalogInput">[docs]</a><span class="k">class</span> <span class="nc">AnalogInput</span><span class="p">:</span>
    <span class="c1">#pylint: disable=too-few-public-methods</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class describing a specific input (channel) on the AlazarTech card.</span>

<span class="sd">    Each AlazarTech card can have many input channels. Instead of maintaining</span>
<span class="sd">    configuration data for all inputs, we dynamically create configuration</span>
<span class="sd">    objects containing the data for just one input. This data is provided as a</span>
<span class="sd">    list of configurations in the AlazarTech configuration data.</span>

<span class="sd">    AnalogInput requires the following configuration data (found in</span>
<span class="sd">    ``self._config[&#39;analog_inputs&#39;]`` and passed to the constructor):</span>

<span class="sd">    ========================= ============== ================================================</span>
<span class="sd">    Key                       Type           Meaning</span>
<span class="sd">    ========================= ============== ================================================</span>
<span class="sd">    input_channel             string         the channel associated with this input</span>
<span class="sd">                                             (must name a constant from the ATS driver file)</span>
<span class="sd">    input_coupling            string         AC or DC coupling</span>
<span class="sd">                                             (must name a constant from the ATS driver file)</span>
<span class="sd">    input_range               string         the voltage input range</span>
<span class="sd">                                             (must name a constant from the ATS driver file)</span>
<span class="sd">    input_impedance           string         the selected impedance for the input</span>
<span class="sd">                                             (must name a constant from the ATS driver file)</span>
<span class="sd">    ========================= ============== ================================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">coupling</span><span class="p">,</span> <span class="n">input_range</span><span class="p">,</span> <span class="n">impedance</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_channel</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_coupling</span> <span class="o">=</span> <span class="n">coupling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_range</span> <span class="o">=</span> <span class="n">input_range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_impedance</span> <span class="o">=</span> <span class="n">impedance</span>

    <span class="k">def</span> <span class="nf">_get_input_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the input channel for this input.</span>

<span class="sd">        :returns: the constant value of the input channel</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_channel</span>

    <span class="k">def</span> <span class="nf">_get_input_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the input range for this input.</span>

<span class="sd">        :returns: the constant value of the input range</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_range</span>

    <span class="k">def</span> <span class="nf">_initialize_on_board</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize analog input on board.</span>

<span class="sd">        :param board: the ATS card to use</span>
<span class="sd">        :type board: ATSGeneric</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">board</span><span class="o">.</span><span class="n">inputControl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_channel</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_input_coupling</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_input_range</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_input_impedance</span><span class="p">)</span></div>


<div class="viewcode-block" id="ATS660"><a class="viewcode-back" href="../../../../alazartech.html#place.plugins.alazartech.alazartech.ATS660">[docs]</a><span class="k">class</span> <span class="nc">ATS660</span><span class="p">(</span><span class="n">ATSGeneric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Subclass for ATS660&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="ATS9440"><a class="viewcode-back" href="../../../../alazartech.html#place.plugins.alazartech.alazartech.ATS9440">[docs]</a><span class="k">class</span> <span class="nc">ATS9440</span><span class="p">(</span><span class="n">ATSGeneric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Subclass for ATS9440&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="ATS9462"><a class="viewcode-back" href="../../../../alazartech.html#place.plugins.alazartech.alazartech.ATS9462">[docs]</a><span class="k">class</span> <span class="nc">ATS9462</span><span class="p">(</span><span class="n">ATSGeneric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Subclass for ATS9462&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<span class="c1"># Private functions</span>


<span class="k">def</span> <span class="nf">_sample_rate_to_hertz</span><span class="p">(</span><span class="n">constant</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Translate sample rate constant to hertz.</span>

<span class="sd">    :param constant: the ATS constant representing the sample rate</span>
<span class="sd">    :type constant: int</span>

<span class="sd">    :returns: the sample rate, in hertz</span>
<span class="sd">    :rtype: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_SAMPLE_RATE_TO_HERTZ</span><span class="p">[</span><span class="n">constant</span><span class="p">]</span>


<span class="n">_SAMPLE_RATE_TO_HERTZ</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_1KSPS</span><span class="p">:</span>         <span class="mi">1000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_2KSPS</span><span class="p">:</span>         <span class="mi">2000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_5KSPS</span><span class="p">:</span>         <span class="mi">5000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_10KSPS</span><span class="p">:</span>       <span class="mi">10000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_20KSPS</span><span class="p">:</span>       <span class="mi">20000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_50KSPS</span><span class="p">:</span>       <span class="mi">50000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_100KSPS</span><span class="p">:</span>     <span class="mi">100000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_200KSPS</span><span class="p">:</span>     <span class="mi">200000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_500KSPS</span><span class="p">:</span>     <span class="mi">500000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_1MSPS</span><span class="p">:</span>      <span class="mi">1000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_2MSPS</span><span class="p">:</span>      <span class="mi">2000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_5MSPS</span><span class="p">:</span>      <span class="mi">5000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_10MSPS</span><span class="p">:</span>    <span class="mi">10000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_20MSPS</span><span class="p">:</span>    <span class="mi">20000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_25MSPS</span><span class="p">:</span>    <span class="mi">25000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_50MSPS</span><span class="p">:</span>    <span class="mi">50000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_100MSPS</span><span class="p">:</span>  <span class="mi">100000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_125MSPS</span><span class="p">:</span>  <span class="mi">125000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_160MSPS</span><span class="p">:</span>  <span class="mi">160000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_180MSPS</span><span class="p">:</span>  <span class="mi">180000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_200MSPS</span><span class="p">:</span>  <span class="mi">200000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_250MSPS</span><span class="p">:</span>  <span class="mi">250000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_400MSPS</span><span class="p">:</span>  <span class="mi">400000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_500MSPS</span><span class="p">:</span>  <span class="mi">500000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_800MSPS</span><span class="p">:</span>  <span class="mi">800000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_1000MSPS</span><span class="p">:</span> <span class="mi">1000000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_1200MSPS</span><span class="p">:</span> <span class="mi">1200000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_1500MSPS</span><span class="p">:</span> <span class="mi">1500000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_1600MSPS</span><span class="p">:</span> <span class="mi">1600000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_1800MSPS</span><span class="p">:</span> <span class="mi">1800000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_2000MSPS</span><span class="p">:</span> <span class="mi">2000000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_2400MSPS</span><span class="p">:</span> <span class="mi">2400000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_3000MSPS</span><span class="p">:</span> <span class="mi">3000000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_3600MSPS</span><span class="p">:</span> <span class="mi">3600000000</span><span class="p">,</span>
    <span class="n">ats</span><span class="o">.</span><span class="n">SAMPLE_RATE_4000MSPS</span><span class="p">:</span> <span class="mi">4000000000</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
    <a id="sidebar-anchor"></a>
    

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
<div id="sidebarbutton" title="Collapse sidebar">
<span></span>
</div>

      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Paul Freeman, Jami L. Johnson, Henrik tom Wrden, and Kasper van Wijk.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.0.2.
    </div>
  </body>
</html>